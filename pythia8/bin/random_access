#!/bin/bash -x

DIR=`realpath $1`
FORMAT="$2"

TMPDIR=`mktemp -d`
mkdir -p $TMPDIR/$(dirname $DIR)
cp -r $DIR $TMPDIR/$DIR
cd $TMPDIR/$DIR

outputCSV="$DIR/random_access_$FORMAT.csv"
rm -f $outputCSV
if [[ ! -f "$outputCSV" ]]; then
    export CPUPROFILE_FREQUENCY=1000
    ENCODED=*.$FORMAT
    for file in $ENCODED; do
        random_access_$FORMAT $file >> $outputCSV
        prof=$file.random_access_prof
        export CPUPROFILE=$prof
        LD_PRELOAD="/usr/lib/libprofiler.so" random_access_$FORMAT $file &> /dev/null
        google-pprof --pdf $(which random_access_$FORMAT) $prof > $DIR/$prof.pdf 2>/dev/null
    done
fi

rm -rf $TMPDIR
